<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checklist Vehículos Blindados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="text-center text-primary mb-4">Checklist de Entrega Final - Vehículo Blindado</h2>

  <form id="formulario">
    <div class="row g-3">
      <div class="col-md-3"><input type="text" id="torre" class="form-control" placeholder="Torre" required></div>
      <div class="col-md-3"><input type="date" id="fecha" class="form-control" required></div>
      <div class="col-md-3">
        <select id="numero_revision" class="form-select" required>
          <option value="">Nº Revisión</option>
          <option value="1ª">1ª</option>
          <option value="2ª">2ª</option>
          <option value="3ª">3ª</option>
        </select>
      </div>
      <div class="col-md-3"><input type="number" id="empleado" class="form-control" placeholder="Empleado" required></div>
      <div class="col-md-3"><input type="text" id="marca" class="form-control" placeholder="Marca" required></div>
      <div class="col-md-3"><input type="text" id="tipo" class="form-control" placeholder="Tipo" required></div>
      <div class="col-md-3"><input type="text" id="nivel" class="form-control" placeholder="Nivel" required></div>
      <div class="col-md-3"><input type="text" id="serie" class="form-control" placeholder="Serie" required></div>
      <div class="col-md-3"><input type="text" id="color" class="form-control" placeholder="Color" required></div>
    </div>

    <div class="mt-4">
      <label for="zona" class="form-label">Zona</label>
      <select id="zona" class="form-select" required>
        <option value="">Selecciona una zona</option>
        <option value="EXTERIORES">EXTERIORES</option>
        <option value="INTERIORES">INTERIORES</option>
        <option value="FUNCIONAMIENTO ELÉCTRICO">FUNCIONAMIENTO ELÉCTRICO</option>
        <option value="PRUEBA DE CARRETERA">PRUEBA DE CARRETERA</option>
        <option value="PRUEBA DE AGUA">PRUEBA DE AGUA</option>
        <option value="INTERIORES CIELO">INTERIORES CIELO</option>
      </select>
    </div>

    <div id="actividades" class="mt-4"></div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-success">Guardar en Local</button>
      <button type="button" id="guardarSheets" class="btn btn-primary">Guardar en Google Sheets</button>
      <button type="button" onclick="limpiarFormulario()" class="btn btn-warning">Limpiar</button>
    </div>
  </form>

  <div class="mt-5">
    <h4>Revisiones guardadas</h4>
    <pre id="output"></pre>
  </div>
</div>

<script>
const actividades = {
  "EXTERIORES": ["Puerta enrasada", "Rin sin daños", "Marca de llanta: [texto]"],
  "INTERIORES": ["Tablero instalado", "Asiento sin daños"],
  "FUNCIONAMIENTO ELÉCTRICO": ["Enciende", "Luces operativas"],
  "PRUEBA DE CARRETERA": ["Sin ruidos", "Suspensión estable"],
  "PRUEBA DE AGUA": ["Sin filtraciones puerta", "Sin filtraciones parabrisas"],
  "INTERIORES CIELO": ["Techo sin filtraciones"]
};

let revisiones = JSON.parse(localStorage.getItem('revisiones')) || [];

function renderActividades(zona) {
  const cont = document.getElementById("actividades");
  cont.innerHTML = "";
  if (!zona) return;
  actividades[zona].forEach((act, i) => {
    const esTexto = act.includes("[texto]");
    let label = act.replace(" [texto]", "");
    cont.innerHTML += `
      <div class="mb-3">
        <label class="form-label">${i + 1}. ${label}</label>
        ${esTexto ? `<input type="text" class="form-control" data-act="${label}" required>` : `
          <select class="form-select" data-act="${label}">
            <option value="">Selecciona</option>
            <option value="L1">L1</option><option value="L2">L2</option>
            <option value="R1">R1</option><option value="R2">R2</option>
            <option value="P1">P1</option><option value="P2">P2</option>
            <option value="OK">OK</option>
          </select>`}
      </div>`;
  });
}

document.getElementById("zona").addEventListener("change", e => {
  renderActividades(e.target.value);
});

function getData() {
  const zona = document.getElementById("zona").value;
  const actividadesDOM = document.querySelectorAll("#actividades [data-act]");
  const actividadesData = [...actividadesDOM].map(el => {
    return {
      actividad: el.dataset.act,
      respuesta: el.value
    };
  });

  return {
    torre: document.getElementById("torre").value,
    fecha: document.getElementById("fecha").value,
    numero_revision: document.getElementById("numero_revision").value,
    empleado: document.getElementById("empleado").value,
    marca: document.getElementById("marca").value,
    tipo: document.getElementById("tipo").value,
    nivel: document.getElementById("nivel").value,
    serie: document.getElementById("serie").value,
    color: document.getElementById("color").value,
    zona: zona,
    actividades: actividadesData
  };
}

document.getElementById("formulario").addEventListener("submit", e => {
  e.preventDefault();
  const data = getData();
  revisiones.push(data);
  localStorage.setItem("revisiones", JSON.stringify(revisiones));
  alert("Guardado localmente");
  document.getElementById("output").textContent = JSON.stringify(revisiones, null, 2);
});

document.getElementById("guardarSheets").addEventListener("click", () => {
  const data = getData();
  fetch("https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_URL/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
    .then(res => res.text())
    .then(res => {
      alert("Enviado a Google Sheets exitosamente");
    })
    .catch(err => alert("Error al guardar en Sheets: " + err));
});

function limpiarFormulario() {
  document.getElementById("formulario").reset();
  document.getElementById("actividades").innerHTML = "";
}
</script>
</body>
</html>
